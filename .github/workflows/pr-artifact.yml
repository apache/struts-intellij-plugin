# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements. See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License. You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Workflow to comment on PRs with artifact download link
# Triggered after Build workflow completes, skipped for Dependabot PRs

name: PR Artifact Comment

on:
  workflow_run:
    workflows: [ "Build" ]
    types:
      - completed

jobs:
  comment:
    name: Comment on PR with artifact link
    # Only run for successful PR builds, skip Dependabot
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.actor.login != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      actions: read
    steps:
      - name: Get PR number and artifact info
        id: pr-info
        uses: actions/github-script@v8
        with:
          script: |
            // Get the PR associated with this workflow run
            const { data: { pull_requests } } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            if (!pull_requests || pull_requests.length === 0) {
              core.setFailed('No PR found for this workflow run');
              return;
            }

            const prNumber = pull_requests[0].number;
            core.setOutput('pr_number', prNumber);

            // Get artifacts from the workflow run
            const { data: { artifacts } } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            // Find the plugin artifact (exclude pr-metadata, tests-result, pluginVerifier-result)
            const pluginArtifact = artifacts.find(a =>
              !['pr-metadata', 'tests-result', 'pluginVerifier-result'].includes(a.name)
            );

            if (pluginArtifact) {
              core.setOutput('artifact_name', pluginArtifact.name);
            } else {
              core.setOutput('artifact_name', 'plugin-artifact');
            }

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = ${{ steps.pr-info.outputs.pr_number }};
            const artifactName = '${{ steps.pr-info.outputs.artifact_name }}';
            const runId = context.payload.workflow_run.id;

            const marker = '<!-- plugin-artifact-comment -->';
            const body = `${marker}
            ðŸ”Œ **Plugin artifact ready for testing!**

            Download from [Actions artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${runId}#artifacts)

            Artifact: \`${artifactName}\``;

            // Find existing comment with marker
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
